<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sign in · Helpdesk</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f5f7fb;--card:#ffffff;--ink:#0f172a;--muted:#6b7280;--accent:#2563eb;
    --accent-600:#1d4ed8;--danger:#ef4444;--ok:#16a34a;--ring: 0 0 0 .25rem rgba(37,99,235,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 'Inter',system-ui,Segoe UI,Roboto,Arial;
    display:grid;place-items:center;padding:24px;
  }
  .card{
    width:min(440px,100%);background:var(--card);border-radius:20px;padding:28px 28px 22px;
    box-shadow:0 10px 30px rgba(15,23,42,.08);
    animation:rise .35s ease-out;
  }
  @keyframes rise{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  h1{margin:4px 0 16px;font-size:28px;letter-spacing:-.02em}
  .muted{color:var(--muted);margin-bottom:22px}
  label{display:block;font-weight:600;margin:12px 0 6px}
  input{
    width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;color:var(--ink);
    outline:0;transition:border .15s, box-shadow .15s;
  }
  input:focus{border-color:var(--accent);box-shadow:var(--ring)}
  .row{display:grid;gap:12px}
  button{
    width:100%;margin-top:14px;padding:12px 14px;border:0;border-radius:12px;background:var(--accent);
    color:#fff;font-weight:700;cursor:pointer;transition:transform .04s ease, background .15s;
    display:inline-grid;grid-auto-flow:column;grid-gap:10px;place-content:center;align-items:center;
  }
  button:hover{background:var(--accent-600)}
  button:active{transform:translateY(1px)}
  .spinner{
    width:16px;height:16px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;
    display:inline-block;animation:spin .7s linear infinite
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .alert{
    margin-top:14px;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;padding:10px 12px;border-radius:10px;
    display:none;animation:pop .2s ease-out
  }
  .alert.show{display:block}
  @keyframes pop{from{transform:scale(.98);opacity:.5}to{transform:scale(1);opacity:1}}
  .tip{color:var(--muted);text-align:center;margin-top:18px}
  .fade-in{animation:fade .15s ease-out}
  @keyframes fade{from{opacity:.6}to{opacity:1}}
</style>
</head>
<body>
  <form class="card" id="loginForm">
    <h1>Sign in</h1>
    <p class="muted">Enter your credentials to access the Helpdesk Dashboard.</p>

    <div class="row">
      <div>
        <label for="user">Username</label>
        <input id="user" name="user" autocomplete="username" placeholder="admin" required />
      </div>
      <div>
        <label for="pass">Password</label>
        <input id="pass" name="pass" type="password" autocomplete="current-password" placeholder="••••••••" required />
      </div>
    </div>

    <button id="submitBtn" type="submit">
      <span class="btn-text">Sign in</span>
    </button>

    <div id="err" class="alert"></div>
    <p class="tip">Tip: use <b>admin</b> as username to get admin rights.</p>
  </form>

<script>
const $ = (sel, el=document) => el.querySelector(sel);

(async function gate(){
  // If already signed-in, go straight to dashboard
  try{
    const r = await fetch('/api?mode=sessionInfo', {credentials:'include'});
    const j = await safeJSON(r);
    if(j?.ok && j?.info?.ok){location.replace('/');}
  }catch{}
})();

$('#loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = $('#submitBtn');
  const text = $('.btn-text', btn);
  const err = $('#err');
  err.classList.remove('show'); err.textContent='';

  // animated state
  text.innerHTML = '<span class="spinner"></span> Signing in…';
  btn.disabled = true;

  try{
    const payload = {
      username: $('#user').value.trim(),
      password: $('#pass').value
    };
    const res = await fetch('/api?mode=login', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify(payload),
      credentials:'include'
    });
    const data = await safeJSON(res);

    if(!data?.ok){
      throw new Error(data?.error || 'Invalid credentials');
    }

    // Success animation then go
    text.innerHTML = '✔ Signed in';
    btn.style.background = 'var(--ok)';
    setTimeout(()=> location.replace('/'), 300);

  }catch(ex){
    btn.disabled = false;
    btn.style.background = 'var(--accent)';
    text.textContent = 'Sign in';
    err.textContent = ex.message || 'Network error';
    err.classList.add('show','fade-in');
  }
});

async function safeJSON(res){
  const t = await res.text();
  try{ return JSON.parse(t); }
  catch{ throw new Error(`Unexpected token '<', "${t.slice(0,20)}"... is not valid JSON`); }
}
</script>
</body>
</html>
