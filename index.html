<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Global Hillview · Enviro Helpdesk Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root { --bg:#f6f7fb; --card:#fff; --txt:#0f172a; --muted:#64748b; --brand:#2563eb; --pill:#eef2ff; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; }
  *{ box-sizing:border-box; font-family:Inter,system-ui,Arial; }
  body{ margin:0; background:var(--bg); color:var(--txt); }
  header{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding:18px 20px; background:#fff; position:sticky; top:0; z-index:2; box-shadow:0 1px 0 #eef; }
  h1{ font-size:22px; margin:0; }
  .btn{ background:var(--brand); color:#fff; border:0; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; }
  .btn[disabled]{ opacity:.7; cursor:wait; }
  .spinner{ width:1em; height:1em; border:2px solid #fff; border-top-color:transparent; border-radius:50%; display:inline-block; vertical-align:-.2em; margin-right:.5em; animation:spin 1s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg);} }
  .wrap{ padding:18px 20px; }
  .stats{ display:grid; grid-template-columns:repeat(4,minmax(180px,1fr)); gap:14px; margin-bottom:14px; }
  .card{ background:var(--card); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(2,6,23,.06);}
  .pill{ display:inline-block; padding:2px 10px; border-radius:999px; background:var(--pill); font-weight:600; }
  table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; background:#fff; }
  th, td{ padding:12px 14px; border-bottom:1px solid #eef1f6; vertical-align:middle; }
  th{ text-transform:uppercase; font-size:12px; letter-spacing:.03em; color:var(--muted); }
  tr:last-child td{ border-bottom:0; }
  select, input[type=text]{ padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; }
  .savebtn{ background:#111827; color:#fff; border:0; border-radius:10px; padding:8px 12px; cursor:pointer; }
  .savebtn.saving{ opacity:.8; cursor:wait; }
  .alert{ background:#fee2e2; color:#991b1b; border-radius:12px; padding:12px 14px; margin-top:12px; display:none; }
</style>
</head>
<body>
<header>
  <h1>Global Hillview, Enviro Helpdesk Dashboard</h1>
  <div>
    <button id="export" class="btn" style="background:#111827">Export CSV</button>
    <button id="logout" class="btn">Logout</button>
  </div>
</header>

<div class="wrap">
  <div class="stats">
    <div class="card"><div class="pill">TOTAL</div><h2 id="sTotal">0</h2></div>
    <div class="card"><div class="pill">OPEN</div><h2 id="sOpen">0</h2></div>
    <div class="card"><div class="pill">IN PROGRESS</div><h2 id="sProg">0</h2></div>
    <div class="card"><div class="pill">RESOLVED</div><h2 id="sRes">0</h2></div>
  </div>

  <div id="err" class="alert"></div>

  <div class="card">
    <table id="tbl">
      <thead>
        <tr>
          <th>Tracking ID</th><th>Date & Time Raised</th><th>Tower</th><th>Flat</th>
          <th>Issue</th><th>Description</th><th>Media</th>
          <th>Status</th><th>Redressal Remark</th><th>User ID</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const qs = (sel, root=document)=>root.querySelector(sel);

async function api(path){
  const res = await fetch(path, { credentials:"same-origin" });
  if (res.status === 401) { location.href="/login"; return; }
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json().catch(async()=>({ raw: await res.text() }));
}

async function requireSession(){
  const r = await api("/api?mode=api&op=sessionInfo");
  if (!r?.info?.ok) location.href="/login";
}

function setStats(rows){
  $("sTotal").textContent = rows.length;
  const open = rows.filter(r=>r.Status==="Open").length;
  const prog = rows.filter(r=>r.Status==="InProgress" || r.Status==="In Progress").length;
  const res = rows.filter(r=>r.Status==="Resolved").length;
  $("sOpen").textContent = open;
  $("sProg").textContent = prog;
  $("sRes").textContent = res;
}

function rowHtml(r){
  const img = r["Media URL"] ? `<img src="${r["Media URL"]}" alt="" style="width:74px;height:74px;object-fit:cover;border-radius:10px;">` : "—";
  const statusId = `st_${r["Tracking ID"]}`;
  const remarkId = `rk_${r["Tracking ID"]}`;
  const btnId = `sv_${r["Tracking ID"]}`;
  return `<tr>
    <td>${r["Tracking ID"]}</td>
    <td>${r["Date and Time Raised"]}</td>
    <td>${r["Tower"]}</td>
    <td>${r["Flat"]}</td>
    <td>${r["Issue"]}</td>
    <td>${r["Description"]||""}</td>
    <td>${img}</td>
    <td><select id="${statusId}">
      ${["Open","In Progress","Resolved"].map(x=>`<option ${r.Status?.startsWith(x)?"selected":""}>${x}</option>`).join("")}
    </select></td>
    <td>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="${remarkId}" type="text" value="${(r["Redressal Remark"]||"").replaceAll('"',"&quot;")}" placeholder="Remark" />
        <button id="${btnId}" class="savebtn">Save</button>
      </div>
    </td>
    <td>${r["User ID"]||""}</td>
  </tr>`;
}

async function loadData(){
  $("err").style.display="none";
  const tbody = qs("#tbl tbody");
  tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:40px;">
    <span class="spinner" style="border-color:#111;border-top-color:transparent"></span> Loading…
  </td></tr>`;
  try{
    const data = await api("/api?mode=data");
    if (!Array.isArray(data)) throw new Error("bad_json");
    setStats(data);
    tbody.innerHTML = data.map(rowHtml).join("");
    data.forEach(r=>{
      const id = r["Tracking ID"];
      const btn = $( "sv_"+id );
      btn.onclick = ()=>saveRow(id);
    });
  }catch(e){
    $("err").textContent = `Network error while fetching data. ${e.message || ""}`;
    $("err").style.display = "block";
    qs("#tbl tbody").innerHTML = "";
  }
}

async function saveRow(id){
  const btn = $("sv_"+id);
  const st = $("st_"+id).value;
  const rk = $("rk_"+id).value.trim();
  const txt = btn.textContent;
  btn.classList.add("saving");
  btn.innerHTML = '<span class="spinner"></span>Saving…';
  try{
    const url = `/api?mode=update&op=save&id=${encodeURIComponent(id)}&status=${encodeURIComponent(st)}&remark=${encodeURIComponent(rk)}`;
    const r = await api(url);
    if (!r?.ok) throw new Error(r?.error || "save_failed");
    btn.textContent = "Saved";
    setTimeout(()=>btn.textContent="Save", 1200);
  }catch(e){
    alert("Save failed: " + (e.message || "error"));
    btn.textContent = txt;
  }finally{
    btn.classList.remove("saving");
  }
}

$("logout").onclick = async ()=>{
  const btn = $("logout");
  const txt = btn.textContent;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Logging out…';
  try{
    const r = await api("/api?mode=api&op=logout");
    if (!r?.ok) throw new Error("Logout failed");
    location.href = "/login";
  }catch(e){
    alert("Logout failed: " + (e.message || "Logout failed"));
    btn.textContent = txt;
    btn.disabled = false;
  }
};

$("export").onclick = ()=>location.href="/api?mode=data"; // raw JSON for quick export

// boot
requireSession().then(loadData);
</script>
</body>
</html>
