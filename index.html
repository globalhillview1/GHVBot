<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Global Hillview, Enviro Helpdesk Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f9fc;--card:#fff;--muted:#6b7280;--text:#0f172a;--border:#e5e7eb;
      --blue:#0d6efd;--green:#22c55e;--amber:#f59e0b;--cyan:#06b6d4;--violet:#7c3aed;--danger:#ef4444;--hover:#f1f5f9;
      --header-h:72px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans";background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:1000;display:flex;justify-content:space-between;align-items:center;gap:12px;padding:16px 18px;background:var(--bg);border-bottom:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:32px;width:auto;border-radius:8px}
    h1{margin:0;font-size:20px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .chip{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);background:var(--card);border-radius:10px;padding:6px 10px}
    .btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{background:var(--hover)}
    .btn.primary{background:var(--blue);color:#fff;border-color:transparent}
    .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
    .btn.small{padding:4px 8px;font-size:12px}
    .sticky{position:sticky;top:var(--header-h);z-index:900;background:var(--bg);padding:10px 18px 12px}
    .kpis{display:grid;grid-template-columns:repeat(6,minmax(150px,1fr));gap:10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
    .card .label{font-size:12px;color:var(--muted);text-transform:uppercase}
    .card .val{font-weight:800;font-size:20px;margin-top:6px}
    .c1{border-left:6px solid var(--green)} .c2{border-left:6px solid #111827}
    .c3{border-left:6px solid var(--amber)} .c4{border-left:6px solid var(--blue)}
    .c5{border-left:6px solid var(--cyan)} .c6{border-left:6px solid var(--violet)}
    .err{display:none;margin:10px 18px;padding:10px;border:1px solid #fecaca;background:#fee2e2;color:#7f1d1d;border-radius:12px}
    .tablewrap{margin:12px 18px;height:calc(100vh - var(--header-h) - 160px);overflow:auto;background:var(--card);border:1px solid var(--border);border-radius:16px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:10px;font-size:13px;text-align:left}
    tbody td{border-top:1px solid var(--border);padding:10px;vertical-align:top;font-size:14px}
    tr:hover td{background:var(--hover)}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700;font-size:12px}
    .Open{background:#111827;color:#fff}.InProgress{background:#f59e0b;color:#111}.Resolved{background:#0d6efd;color:#fff}
    .edit{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:var(--card)}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="https://drive.google.com/uc?export=view&id=1opE1H0_mWwguRjSaDlGPPVV3wN8Pn2jM" alt="logo" />
      <h1>Global Hillview, Enviro Helpdesk Dashboard</h1>
    </div>
    <div class="toolbar">
      <label class="chip">Timezone:
        <select id="tz"><option value="local">Local</option><option value="utc">UTC</option></select>
      </label>
      <label class="chip">Auto-refresh <input id="ar" type="checkbox" checked /> <span style="color:#6b7280">60s</span></label>
      <button id="csv" class="btn">Export CSV</button>
      <button id="logout" class="btn danger"><span id="logoutText">Logout</span></button>
    </div>
  </header>

  <div class="sticky">
    <section class="kpis">
      <div class="card c1"><div class="label">Total</div><div id="kpiTotal" class="val">0</div></div>
      <div class="card c2"><div class="label">Open</div><div id="kpiOpen" class="val">0</div></div>
      <div class="card c3"><div class="label">In Progress</div><div id="kpiProgress" class="val">0</div></div>
      <div class="card c4"><div class="label">Resolved</div><div id="kpiResolved" class="val">0</div></div>
      <div class="card c5"><div class="label">Avg Resolution</div><div id="kpiAvgTime" class="val">0m</div></div>
      <div class="card c6"><div class="label">Avg Rating</div><div id="kpiAvgRating" class="val">0</div></div>
    </section>
  </div>

  <div id="err" class="err">Network error while fetching data.</div>

  <div class="tablewrap">
    <table id="grid">
      <thead>
        <tr>
          <th>Tracking ID</th>
          <th>Date & Time Raised</th>
          <th>Tower</th>
          <th>Flat</th>
          <th>Issue</th>
          <th>Description</th>
          <th>Media</th>
          <th>Status</th>
          <th>Redressal Remark</th>
          <th>User ID</th>
          <th>Date & Time Resolved</th>
          <th>Time Taken</th>
          <th>Feedback</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const API="/api";
    const $=(s)=>document.querySelector(s);

    // Auth gate
    function tok(){try{return localStorage.getItem("session");}catch(e){return null}}
    function role(){try{return localStorage.getItem("role")||"user";}catch(e){return "user"}}
    if(!tok()){ location.replace("/login"); }

    const state={all:[],isAdmin:role()==="admin"};

    // Logout animation
    $("#logout").onclick=()=>{ $("#logoutText").textContent="Logging out…"; setTimeout(()=>{localStorage.clear(); location.replace("/login");},800); };

    async function load(){
      try{
        const r=await fetch(API+"?mode=data",{cache:"no-store"});
        const data=await r.json();
        state.all=data;
        render();
      }catch(e){
        $("#err").style.display="block";
      }
    }

    function cellMedia(u){
      if(!u) return "";
      return `<a href="${u}" target="_blank" rel="noopener">Media</a>`;
    }

    function rowHtml(r){
      const id=r["Tracking ID"];
      const st=r["Status"]||"Open";
      const remark=r["Redressal Remark"]||"";
      const admin=state.isAdmin;

      const statusCell = admin
        ? `<select id="st-${id}" class="edit">
             <option ${st==="Open"?"selected":""}>Open</option>
             <option ${st==="InProgress"?"selected":""}>InProgress</option>
             <option ${st==="Resolved"?"selected":""}>Resolved</option>
           </select>`
        : `<span class="badge ${st.replace(/\s+/g,"")}">${st}</span>`;

      const remarkCell = admin
        ? `<div style="display:flex;gap:6px;align-items:center">
             <input id="rm-${id}" class="edit" value="${remark.replace(/"/g,"&quot;")}" />
             <button id="sv-${id}" class="btn small primary" onclick="saveRow('${id}')">Save</button>
           </div>`
        : (remark||"");

      return `
        <tr>
          <td>${id}</td>
          <td>${r["Date and Time Raised"]||""}</td>
          <td>${r["Tower"]||""}</td>
          <td>${r["Flat"]||""}</td>
          <td>${r["Issue"]||""}</td>
          <td>${r["Description"]||""}</td>
          <td>${cellMedia(r["Media URL"])}</td>
          <td>${statusCell}</td>
          <td>${remarkCell}</td>
          <td>${r["User ID"]||""}</td>
          <td>${r["Date and Time Resolved"]||""}</td>
          <td>${r["Time Taken"]||""}</td>
          <td>${r["Feedback Rating"]||""}</td>
        </tr>`;
    }

    function render(){
      const tb=$("#grid tbody");
      tb.innerHTML = state.all.map(rowHtml).join("");
      // KPIs
      const total=state.all.length;
      const open=state.all.filter(x=>x.Status==="Open").length;
      const inprog=state.all.filter(x=>x.Status==="InProgress").length;
      const resolved=state.all.filter(x=>x.Status==="Resolved").length;
      $("#kpiTotal").textContent=total;
      $("#kpiOpen").textContent=open;
      $("#kpiProgress").textContent=inprog;
      $("#kpiResolved").textContent=resolved;
      // (Avg time / rating are sample placeholders unless your GAS returns them precomputed)
      $("#kpiAvgTime").textContent="0m";
      const ratings=state.all.map(x=>Number(x["Feedback Rating"]||0)).filter(n=>!Number.isNaN(n));
      $("#kpiAvgRating").textContent=ratings.length? (ratings.reduce((a,b)=>a+b,0)/ratings.length).toFixed(1) : "0";
    }

    // Save with animation
    async function saveRow(id){
      const stEl=$("#st-"+id), rmEl=$("#rm-"+id), btn=$("#sv-"+id);
      const status=stEl?.value ?? "";
      const remark=rmEl?.value ?? "";
      btn.textContent="Saving…"; btn.disabled=true;

      try{
        const r=await fetch(API+"?mode=api&op=update",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({ token:tok(), op:"update", id, status, remark })
        });
        const j=await r.json();
        if(!j.ok) throw new Error(j.error||"Failed");
        btn.textContent="Saved ✓";
        setTimeout(()=>{ btn.textContent="Save"; btn.disabled=false; load(); },800);
      }catch(e){
        btn.textContent="Failed ✕";
        setTimeout(()=>{ btn.textContent="Save"; btn.disabled=false; },1200);
      }
    }
    window.saveRow=saveRow;

    // Auto refresh
    let timer=null;
    $("#ar").onchange=()=>{ if($("#ar").checked){ timer=setInterval(load,60000);} else { clearInterval(timer);} };
    if($("#ar").checked){ timer=setInterval(load,60000); }

    // Start
    load();
  </script>
</body>
</html>
